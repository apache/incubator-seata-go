{
  "Name": "OrderSaga",
  "Version": "2.0",
  "StartState": "ValidateOrder",
  "trans_operation_timeout": 45000,
  "States": {
    "ValidateOrder": {
      "Type": "ServiceTask",
      "ServiceType": "local",
      "ServiceName": "validationService",
      "ServiceMethod": "validateOrderParams",
      "CompensateState": "SkipValidation",
      "ForCompensation": false,
      "ForUpdate": false,
      "Catches": [
        {
          "Exceptions": [
            "InvalidOrderParamsException"
          ],
          "Next": "ErrorHandler"
        }
      ],
      "Status": {
        "return.valid == true": "VALID",
        "return.valid == false": "INVALID",
        "$exception{*}": "UNKNOWN"
      },
      "Input": [
        {
          "orderInfo": "$.orderInfo"
        }
      ],
      "Output": {
        "validationResult": "$.#root"
      },
      "Next": "CreateOrder"
    },
    "CreateOrder": {
      "Type": "ServiceTask",
      "ServiceType": "local",
      "ServiceName": "orderService",
      "ServiceMethod": "createOrder",
      "CompensateState": "CancelOrder",
      "ForCompensation": false,
      "ForUpdate": false,
      "Retry": [
        {
          "Exceptions": [
            "OrderCreationException",
            "InventoryUnavailableException"
          ],
          "IntervalSeconds": 3,
          "MaxAttempts": 4,
          "BackoffRate": 1.5
        }
      ],
      "Catches": [
        {
          "Exceptions": [
            "OrderCreationException",
            "InventoryUnavailableException"
          ],
          "Next": "ErrorHandler"
        }
      ],
      "Status": {
        "return.code == 'SUCCESS'": "SUCCEEDED",
        "return.code == 'FAIL'": "FAILED",
        "$exception{*}": "UNKNOWN"
      },
      "Input": [
        {
          "orderInfo": "$.orderInfo"
        }
      ],
      "Output": {
        "orderId": "$.#root"
      },
      "Next": "CheckStock",
      "Loop": {
        "Parallel": 1,
        "Collection": "$.orderItems",
        "ElementVariableName": "item",
        "ElementIndexName": "index",
        "CompletionCondition": "[nrOfInstances] == [nrOfCompletedInstances]"
      }
    },
    "CheckStock": {
      "Type": "ServiceTask",
      "ServiceType": "local",
      "ServiceName": "inventoryService",
      "ServiceMethod": "checkAvailability",
      "CompensateState": "RollbackStock",
      "ForCompensation": false,
      "ForUpdate": false,
      "Retry": [
        {
          "Exceptions": [
            "StockCheckException"
          ],
          "IntervalSeconds": 2,
          "MaxAttempts": 2,
          "BackoffRate": 1.2
        }
      ],
      "Catches": [
        {
          "Exceptions": [
            "StockCheckException"
          ],
          "Next": "ErrorHandler"
        }
      ],
      "Status": {
        "return.available == true": "IN_STOCK",
        "return.available == false": "OUT_OF_STOCK",
        "$exception{*}": "UNKNOWN"
      },
      "Input": [
        {
          "orderId": "$.orderId"
        },
        {
          "itemsList": "$.orderItems"
        }
      ],
      "Output": {
        "stockAvailable": "$.#root"
      },
      "Next": "DecideStock"
    },
    "DecideStock": {
      "Type": "Choice",
      "Choices": [
        {
          "Expression": "stockAvailable == true",
          "Next": "ReserveStock"
        },
        {
          "Expression": "stockAvailable == false",
          "Next": "CancelOrder"
        }
      ],
      "Default": "ErrorHandler"
    },
    "ReserveStock": {
      "Type": "ServiceTask",
      "ServiceType": "local",
      "ServiceName": "inventoryService",
      "ServiceMethod": "reserveItems",
      "CompensateState": "RollbackStock",
      "ForCompensation": false,
      "ForUpdate": false,
      "Retry": [
        {
          "Exceptions": [
            "StockReservationException"
          ],
          "IntervalSeconds": 2,
          "MaxAttempts": 2,
          "BackoffRate": 1.2
        }
      ],
      "Catches": [
        {
          "Exceptions": [
            "StockReservationException"
          ],
          "Next": "ErrorHandler"
        }
      ],
      "Status": {
        "return.code == 'RESERVED'": "STOCK_RESERVED",
        "return.code == 'FAILED'": "FAILED",
        "$exception{*}": "UNKNOWN"
      },
      "Input": [
        {
          "orderId": "$.orderId"
        },
        {
          "itemList": "$.orderItems"
        }
      ],
      "Output": {
        "stockReservationId": "$.#root"
      },
      "Next": "ProcessPayment"
    },
    "ProcessPayment": {
      "Type": "ServiceTask",
      "ServiceType": "local",
      "ServiceName": "paymentService",
      "ServiceMethod": "processPayment",
      "CompensateState": "RefundPayment",
      "ForCompensation": false,
      "ForUpdate": false,
      "Retry": [
        {
          "Exceptions": [
            "PaymentProcessingException"
          ],
          "IntervalSeconds": 3,
          "MaxAttempts": 3,
          "BackoffRate": 1.5
        }
      ],
      "Catches": [
        {
          "Exceptions": [
            "PaymentProcessingException"
          ],
          "Next": "ErrorHandler"
        }
      ],
      "Status": {
        "return.code == 'PAID'": "PAYMENT_SUCCESS",
        "return.code == 'DECLINED'": "PAYMENT_FAILED",
        "$exception{*}": "UNKNOWN"
      },
      "Input": [
        {
          "orderId": "$.orderId"
        },
        {
          "amount": "$.orderTotal"
        }
      ],
      "Output": {
        "paymentTransactionId": "$.#root"
      },
      "Next": "CompleteOrder"
    },
    "CompleteOrder": {
      "Type": "Succeed"
    },
    "CancelOrder": {
      "Type": "ServiceTask",
      "ServiceType": "local",
      "ServiceName": "orderService",
      "ServiceMethod": "cancelOrder",
      "ForCompensation": true,
      "ForUpdate": true,
      "Input": [
        {
          "orderId": "$.orderId"
        }
      ],
      "Output": {
        "cancelResult": "$.#root"
      },
      "Next": "RollbackStock"
    },
    "RollbackStock": {
      "Type": "ServiceTask",
      "ServiceType": "local",
      "ServiceName": "inventoryService",
      "ServiceMethod": "releaseItems",
      "ForCompensation": true,
      "ForUpdate": true,
      "Input": [
        {
          "orderId": "$.orderId"
        },
        {
          "stockReservationId": "$.stockReservationId"
        }
      ],
      "Output": {
        "rollbackResult": "$.#root"
      },
      "Next": "RefundPayment"
    },
    "RefundPayment": {
      "Type": "ServiceTask",
      "ServiceType": "local",
      "ServiceName": "paymentService",
      "ServiceMethod": "refundPayment",
      "ForCompensation": true,
      "ForUpdate": true,
      "Input": [
        {
          "orderId": "$.orderId"
        },
        {
          "paymentTransactionId": "$.paymentTransactionId"
        }
      ],
      "Output": {
        "refundResult": "$.#root"
      },
      "Next": "FailState"
    },
    "ErrorHandler": {
      "Type": "Fail",
      "ErrorCode": "ORDER_PROCESSING_ERROR_V2",
      "Message": "v2版本：订单处理发生不可恢复错误"
    },
    "FailState": {
      "Type": "Fail",
      "ErrorCode": "ORDER_CANCELLED",
      "Message": "The order has been cancelled and compensation actions have been completed."
    },
    "SkipValidation": {
      "Type": "ServiceTask",
      "ServiceType": "local",
      "ServiceName": "validationService",
      "ServiceMethod": "skipValidation",
      "ForCompensation": true,
      "ForUpdate": true,
      "Input": [
        {
          "orderId": "$.orderId"
        }
      ],
      "Output": {
        "skipResult": "Validation compensation skipped"
      },
      "Next": "CancelOrder"
    }
  }
}
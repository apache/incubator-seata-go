package parser

import (
	"testing"
)

func TestParseChoice(t *testing.T) {
	var content = "{\n    \"Name\":\"ChoiceTest\",\n    \"Comment\":\"ChoiceTest\",\n    \"StartState\":\"ChoiceState\",\n    \"Version\":\"0.0.1\",\n    \"States\":{\n        \"ChoiceState\":{\n            \"Type\":\"Choice\",\n            \"Choices\":[\n                {\n                    \"Expression\":\"[a] == 1\",\n                    \"Next\":\"SecondState\"\n                },\n                {\n                    \"Expression\":\"[a] == 2\",\n                    \"Next\":\"ThirdState\"\n                }\n            ],\n            \"Default\":\"Fail\"\n        }\n    }\n}"
	_, err := NewJSONStateMachineParser().Parse(content)
	if err != nil {
		t.Error("parse fail: " + err.Error())
	}
}

func TestParseServiceTask(t *testing.T) {
	content := "{\n    \"Name\": \"StateMachineNewDesigner\",\n    \"Comment\": \"This state machine is modeled by designer tools.\",\n    \"Version\": \"0.0.1\",\n    \"style\": {\n        \"bounds\": {\n            \"x\": 200,\n            \"y\": 200,\n            \"width\": 36,\n            \"height\": 36\n        }\n    },\n    \"States\": {\n        \"ServiceTask-a9h2o51\": {\n            \"style\": {\n                \"bounds\": {\n                    \"x\": 300,\n                    \"y\": 178,\n                    \"width\": 100,\n                    \"height\": 80\n                }\n            },\n            \"Name\": \"ServiceTask-a9h2o51\",\n            \"IsForCompensation\": false,\n            \"Input\": [\n                {}\n            ],\n            \"Output\": {},\n            \"Status\": {},\n            \"Retry\": [],\n            \"ServiceName\": \"\",\n            \"ServiceMethod\": \"\",\n            \"Type\": \"ServiceTask\",\n            \"Next\": \"Choice-4ajl8nt\",\n            \"edge\": {\n                \"Choice-4ajl8nt\": {\n                    \"style\": {\n                        \"waypoints\": [\n                            {\n                                \"original\": {\n                                    \"x\": 400,\n                                    \"y\": 218\n                                },\n                                \"x\": 400,\n                                \"y\": 218\n                            },\n                            {\n                                \"x\": 435,\n                                \"y\": 218\n                            },\n                            {\n                                \"original\": {\n                                    \"x\": 455,\n                                    \"y\": 218\n                                },\n                                \"x\": 455,\n                                \"y\": 218\n                            }\n                        ],\n                        \"source\": \"ServiceTask-a9h2o51\",\n                        \"target\": \"Choice-4ajl8nt\"\n                    },\n                    \"Type\": \"Transition\"\n                }\n            },\n            \"CompensateState\": \"CompensateFirstState\"\n        },\n        \"Choice-4ajl8nt\": {\n            \"style\": {\n                \"bounds\": {\n                    \"x\": 455,\n                    \"y\": 193,\n                    \"width\": 50,\n                    \"height\": 50\n                }\n            },\n            \"Name\": \"Choice-4ajl8nt\",\n            \"Type\": \"Choice\",\n            \"Choices\": [\n                {\n                    \"Expression\": \"\",\n                    \"Next\": \"SubStateMachine-cauj9uy\"\n                },\n                {\n                    \"Expression\": \"\",\n                    \"Next\": \"ServiceTask-vdij28l\"\n                }\n            ],\n            \"Default\": \"SubStateMachine-cauj9uy\",\n            \"edge\": {\n                \"SubStateMachine-cauj9uy\": {\n                    \"style\": {\n                        \"waypoints\": [\n                            {\n                                \"original\": {\n                                    \"x\": 505,\n                                    \"y\": 218\n                                },\n                                \"x\": 505,\n                                \"y\": 218\n                            },\n                            {\n                                \"x\": 530,\n                                \"y\": 218\n                            },\n                            {\n                                \"original\": {\n                                    \"x\": 550,\n                                    \"y\": 218\n                                },\n                                \"x\": 550,\n                                \"y\": 218\n                            }\n                        ],\n                        \"source\": \"Choice-4ajl8nt\",\n                        \"target\": \"SubStateMachine-cauj9uy\"\n                    },\n                    \"Type\": \"ChoiceEntry\"\n                },\n                \"ServiceTask-vdij28l\": {\n                    \"style\": {\n                        \"waypoints\": [\n                            {\n                                \"original\": {\n                                    \"x\": 480,\n                                    \"y\": 243\n                                },\n                                \"x\": 480,\n                                \"y\": 243\n                            },\n                            {\n                                \"x\": 600,\n                                \"y\": 290\n                            },\n                            {\n                                \"original\": {\n                                    \"x\": 600,\n                                    \"y\": 310\n                                },\n                                \"x\": 600,\n                                \"y\": 310\n                            }\n                        ],\n                        \"source\": \"Choice-4ajl8nt\",\n                        \"target\": \"ServiceTask-vdij28l\"\n                    },\n                    \"Type\": \"ChoiceEntry\"\n                }\n            }\n        },\n        \"CompensateFirstState\": {\n            \"style\": {\n                \"bounds\": {\n                    \"x\": 300,\n                    \"y\": 310,\n                    \"width\": 100,\n                    \"height\": 80\n                }\n            },\n            \"Name\": \"CompensateFirstState\",\n            \"IsForCompensation\": true,\n            \"Input\": [\n                {}\n            ],\n            \"Output\": {},\n            \"Status\": {},\n            \"Retry\": [],\n            \"ServiceName\": \"\",\n            \"ServiceMethod\": \"\",\n            \"Type\": \"ServiceTask\"\n        },\n        \"SubStateMachine-cauj9uy\": {\n            \"style\": {\n                \"bounds\": {\n                    \"x\": 550,\n                    \"y\": 178,\n                    \"width\": 100,\n                    \"height\": 80\n                }\n            },\n            \"Name\": \"SubStateMachine-cauj9uy\",\n            \"IsForCompensation\": false,\n            \"Input\": [\n                {}\n            ],\n            \"Output\": {},\n            \"Status\": {},\n            \"Retry\": [],\n            \"StateMachineName\": \"\",\n            \"Type\": \"SubStateMachine\",\n            \"Next\": \"Succeed-5x3z98u\",\n            \"edge\": {\n                \"Succeed-5x3z98u\": {\n                    \"style\": {\n                        \"waypoints\": [\n                            {\n                                \"original\": {\n                                    \"x\": 650,\n                                    \"y\": 218\n                                },\n                                \"x\": 650,\n                                \"y\": 218\n                            },\n                            {\n                                \"x\": 702,\n                                \"y\": 218\n                            },\n                            {\n                                \"original\": {\n                                    \"x\": 722,\n                                    \"y\": 218\n                                },\n                                \"x\": 722,\n                                \"y\": 218\n                            }\n                        ],\n                        \"source\": \"SubStateMachine-cauj9uy\",\n                        \"target\": \"Succeed-5x3z98u\"\n                    },\n                    \"Type\": \"Transition\"\n                }\n            }\n        },\n        \"ServiceTask-vdij28l\": {\n            \"style\": {\n                \"bounds\": {\n                    \"x\": 550,\n                    \"y\": 310,\n                    \"width\": 100,\n                    \"height\": 80\n                }\n            },\n            \"Name\": \"ServiceTask-vdij28l\",\n            \"IsForCompensation\": false,\n            \"Input\": [\n                {}\n            ],\n            \"Output\": {},\n            \"Status\": {},\n            \"Retry\": [],\n            \"ServiceName\": \"\",\n            \"ServiceMethod\": \"\",\n            \"Catch\": [\n                {\n                    \"Exceptions\": [],\n                    \"Next\": \"CompensationTrigger-uldp2ou\"\n                }\n            ],\n            \"Type\": \"ServiceTask\",\n            \"catch\": {\n                \"style\": {\n                    \"bounds\": {\n                        \"x\": 632,\n                        \"y\": 372,\n                        \"width\": 36,\n                        \"height\": 36\n                    }\n                },\n                \"edge\": {\n                    \"CompensationTrigger-uldp2ou\": {\n                        \"style\": {\n                            \"waypoints\": [\n                                {\n                                    \"original\": {\n                                        \"x\": 668,\n                                        \"y\": 390\n                                    },\n                                    \"x\": 668,\n                                    \"y\": 390\n                                },\n                                {\n                                    \"x\": 702,\n                                    \"y\": 390\n                                },\n                                {\n                                    \"original\": {\n                                        \"x\": 722,\n                                        \"y\": 390\n                                    },\n                                    \"x\": 722,\n                                    \"y\": 390\n                                }\n                            ],\n                            \"source\": \"ServiceTask-vdij28l\",\n                            \"target\": \"CompensationTrigger-uldp2ou\"\n                        },\n                        \"Type\": \"ExceptionMatch\"\n                    }\n                }\n            },\n            \"Next\": \"Succeed-5x3z98u\",\n            \"edge\": {\n                \"Succeed-5x3z98u\": {\n                    \"style\": {\n                        \"waypoints\": [\n                            {\n                                \"original\": {\n                                    \"x\": 600,\n                                    \"y\": 310\n                                },\n                                \"x\": 600,\n                                \"y\": 310\n                            },\n                            {\n                                \"x\": 740,\n                                \"y\": 256\n                            },\n                            {\n                                \"original\": {\n                                    \"x\": 740,\n                                    \"y\": 236\n                                },\n                                \"x\": 740,\n                                \"y\": 236\n                            }\n                        ],\n                        \"source\": \"ServiceTask-vdij28l\",\n                        \"target\": \"Succeed-5x3z98u\"\n                    },\n                    \"Type\": \"Transition\"\n                }\n            }\n        },\n        \"Succeed-5x3z98u\": {\n            \"style\": {\n                \"bounds\": {\n                    \"x\": 722,\n                    \"y\": 200,\n                    \"width\": 36,\n                    \"height\": 36\n                }\n            },\n            \"Name\": \"Succeed-5x3z98u\",\n            \"Type\": \"Succeed\"\n        },\n        \"CompensationTrigger-uldp2ou\": {\n            \"style\": {\n                \"bounds\": {\n                    \"x\": 722,\n                    \"y\": 372,\n                    \"width\": 36,\n                    \"height\": 36\n                }\n            },\n            \"Name\": \"CompensationTrigger-uldp2ou\",\n            \"Type\": \"CompensationTrigger\",\n            \"Next\": \"Fail-9roxcv5\",\n            \"edge\": {\n                \"Fail-9roxcv5\": {\n                    \"style\": {\n                        \"waypoints\": [\n                            {\n                                \"original\": {\n                                    \"x\": 758,\n                                    \"y\": 390\n                                },\n                                \"x\": 758,\n                                \"y\": 390\n                            },\n                            {\n                                \"x\": 792,\n                                \"y\": 390\n                            },\n                            {\n                                \"original\": {\n                                    \"x\": 812,\n                                    \"y\": 390\n                                },\n                                \"x\": 812,\n                                \"y\": 390\n                            }\n                        ],\n                        \"source\": \"CompensationTrigger-uldp2ou\",\n                        \"target\": \"Fail-9roxcv5\"\n                    },\n                    \"Type\": \"Transition\"\n                }\n            }\n        },\n        \"Fail-9roxcv5\": {\n            \"style\": {\n                \"bounds\": {\n                    \"x\": 812,\n                    \"y\": 372,\n                    \"width\": 36,\n                    \"height\": 36\n                }\n            },\n            \"Name\": \"Fail-9roxcv5\",\n            \"ErrorCode\": \"\",\n            \"Message\": \"\",\n            \"Type\": \"Fail\"\n        }\n    },\n    \"StartState\": \"ServiceTask-a9h2o51\",\n    \"edge\": {\n        \"style\": {\n            \"waypoints\": [\n                {\n                    \"original\": {\n                        \"x\": 236,\n                        \"y\": 218\n                    },\n                    \"x\": 236,\n                    \"y\": 218\n                },\n                {\n                    \"x\": 280,\n                    \"y\": 218\n                },\n                {\n                    \"original\": {\n                        \"x\": 300,\n                        \"y\": 218\n                    },\n                    \"x\": 300,\n                    \"y\": 218\n                }\n            ],\n            \"target\": \"ServiceTask-a9h2o51\"\n        },\n        \"Type\": \"Transition\"\n    }\n}"
	_, err := NewJSONStateMachineParser().Parse(content)
	if err != nil {
		t.Error("parse fail: " + err.Error())
	}
}
